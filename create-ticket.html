<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Create Ticket - IT Help Desk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="/src/style.css">
  </head>
  <body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="#">IT Help Desk</a>
        <div class="collapse navbar-collapse justify-content-end" id="nav">
          <ul class="navbar-nav align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">Dashboard</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0">Create New Support Ticket</h4>
            </div>
            <div class="card-body">
              <div id="alertContainer"></div>

              <form id="ticketForm">
                <!-- Title Field -->
                <div class="mb-3">
                  <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="title" required placeholder="Brief description of your issue">
                </div>

                <!-- Category Field -->
                <div class="mb-3">
                  <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                  <select class="form-select" id="category" required>
                    <option value="">Loading categories...</option>
                  </select>
                </div>

                <!-- Priority Field -->
                <div class="mb-3">
                  <label for="priority" class="form-label">Priority <span class="text-danger">*</span></label>
                  <select class="form-select" id="priority" required>
                    <option value="">Select priority...</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                  </select>
                </div>

                <!-- Description Field -->
                <div class="mb-3">
                  <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                  <textarea class="form-control" id="description" rows="5" required placeholder="Provide detailed information about your issue"></textarea>
                </div>

                <!-- Attachment Field -->
                <div class="mb-3">
                  <label for="fileUpload" class="form-label">Attachment (Optional)</label>
                  <input type="file" class="form-control" id="fileUpload" accept="image/*">
                  <div class="form-text">Upload an image if needed (PNG, JPG, GIF)</div>
                </div>

                <!-- Submit Button -->
                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary" id="submitBtn">
                    Create Ticket
                  </button>
                  <a href="dashboard.html" class="btn btn-outline-secondary">Cancel</a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { supabase } from './src/supabase.js'

      // Auth check - redirect if not logged in
      async function checkAuth() {
        const { data: { session }, error } = await supabase.auth.getSession()
        
        if (error || !session) {
          window.location.href = 'login.html'
          return null
        }
        
        return session
      }

      // Load categories from Supabase
      async function loadCategories() {
        try {
          const { data, error } = await supabase
            .from('categories')
            .select('*')
            .order('name')

          if (error) throw error

          const categorySelect = document.getElementById('category')
          
          if (data && data.length > 0) {
            categorySelect.innerHTML = '<option value="">Select a category...</option>'
            data.forEach(category => {
              const option = document.createElement('option')
              option.value = category.id
              option.textContent = category.name
              categorySelect.appendChild(option)
            })
          } else {
            categorySelect.innerHTML = '<option value="">No categories available</option>'
          }
        } catch (error) {
          console.error('Error loading categories:', error)
          showAlert('Failed to load categories. Please refresh the page.', 'danger')
        }
      }

      // Show alert messages
      function showAlert(message, type = 'info') {
        const alertContainer = document.getElementById('alertContainer')
        const alert = document.createElement('div')
        alert.className = `alert alert-${type} alert-dismissible fade show`
        alert.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `
        alertContainer.innerHTML = ''
        alertContainer.appendChild(alert)
      }

      // Handle form submission
      document.getElementById('ticketForm').addEventListener('submit', async (e) => {
        e.preventDefault()

        const submitBtn = document.getElementById('submitBtn')
        const originalBtnText = submitBtn.textContent

        try {
          // Disable button and show loading state
          submitBtn.disabled = true
          submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Creating...'

          // Get current session
          const { data: { session }, error: sessionError } = await supabase.auth.getSession()
          if (sessionError || !session) {
            throw new Error('Not authenticated')
          }

          const userId = session.user.id
          const title = document.getElementById('title').value
          const categoryId = document.getElementById('category').value
          const priority = document.getElementById('priority').value
          const description = document.getElementById('description').value
          const fileInput = document.getElementById('fileUpload')

          let attachmentUrl = null

          // Handle file upload if a file is selected
          if (fileInput.files && fileInput.files[0]) {
            const file = fileInput.files[0]
            const fileExt = file.name.split('.').pop()
            const fileName = `${Date.now()}.${fileExt}`
            const filePath = `${userId}/${fileName}`

            const { data: uploadData, error: uploadError } = await supabase.storage
              .from('attachments')
              .upload(filePath, file)

            if (uploadError) {
              throw new Error(`File upload failed: ${uploadError.message}`)
            }

            // Get public URL
            const { data: publicUrlData } = supabase.storage
              .from('attachments')
              .getPublicUrl(filePath)

            attachmentUrl = publicUrlData.publicUrl
          }

          // Insert ticket into database
          const { data, error } = await supabase
            .from('tickets')
            .insert([
              {
                user_id: userId,
                category_id: categoryId,
                title: title,
                description: description,
                priority: priority,
                attachment_url: attachmentUrl,
                status: 'open'
              }
            ])
            .select()

          if (error) throw error

          // Success - show alert and redirect
          alert('Ticket created successfully!')
          window.location.href = 'dashboard.html'

        } catch (error) {
          console.error('Error creating ticket:', error)
          showAlert(`Error: ${error.message}`, 'danger')
          
          // Re-enable button
          submitBtn.disabled = false
          submitBtn.textContent = originalBtnText
        }
      })

      // Initialize page
      ;(async () => {
        const session = await checkAuth()
        if (session) {
          await loadCategories()
        }
      })()
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </body>
</html>
