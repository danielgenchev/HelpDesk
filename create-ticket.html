<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Create Ticket - IT Help Desk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="/src/style.css">
    <script>
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.setAttribute('data-bs-theme', 'dark');
      }
    </script>
  </head>
  <body class="bg-body-secondary">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="dashboard.html" data-i18n="brand">IT Help Desk</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="nav">
          <ul class="navbar-nav align-items-center">
            <li class="nav-item dropdown me-3">
              <a class="nav-link dropdown-toggle text-white" href="#" id="langLabel" role="button" data-bs-toggle="dropdown">üåê EN</a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" onclick="changeLanguage('en')">English (EN)</a></li>
                <li><a class="dropdown-item" href="#" onclick="changeLanguage('bg')">–ë—ä–ª–≥–∞—Ä—Å–∫–∏ (BG)</a></li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white" href="dashboard.html" data-i18n="backBtn">‚Üê Back to Dashboard</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0" data-i18n="createTitle">Create New Support Ticket</h4>
            </div>
            <div class="card-body">
              <div id="alertContainer"></div>

              <form id="ticketForm">
                <div class="mb-3">
                  <label for="title" class="form-label"><span data-i18n="labelTitle">Title</span> <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="title" required data-i18n-placeholder="placeholderTitle" placeholder="Brief description of your issue">
                </div>

                <div class="mb-3">
                  <label for="category" class="form-label"><span data-i18n="labelCategory">Category</span> <span class="text-danger">*</span></label>
                  <select class="form-select" id="category" required>
                    <option value="" data-i18n="loadingCat">Loading categories...</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="priority" class="form-label"><span data-i18n="labelPriority">Priority</span> <span class="text-danger">*</span></label>
                  <select class="form-select" id="priority" required>
                    <option value="" data-i18n="selectPriority">Select priority...</option>
                    <option value="low" data-i18n="low">Low</option>
                    <option value="medium" data-i18n="medium">Medium</option>
                    <option value="high" data-i18n="high">High</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="description" class="form-label"><span data-i18n="labelDesc">Description</span> <span class="text-danger">*</span></label>
                  <textarea class="form-control" id="description" rows="5" required data-i18n-placeholder="placeholderDesc" placeholder="Provide detailed information about your issue"></textarea>
                </div>

                <div class="mb-3">
                  <label for="fileUpload" class="form-label" data-i18n="labelAttach">Attachment (Optional)</label>
                  <input type="file" class="form-control" id="fileUpload" accept="image/*">
                  <div class="form-text" data-i18n="helpAttach">Upload an image if needed (PNG, JPG, GIF)</div>
                </div>

                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary" id="submitBtn" data-i18n="submitBtn">Create Ticket</button>
                  <a href="dashboard.html" class="btn btn-outline-secondary" data-i18n="cancelBtn">Cancel</a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { supabase } from './src/supabase.js'

      // i18n –õ–æ–≥–∏–∫–∞
      const dictionary = {
        en: {
          brand: "IT Help Desk", backBtn: "‚Üê Back to Dashboard",
          createTitle: "Create New Support Ticket", labelTitle: "Title", placeholderTitle: "Brief description of your issue",
          labelCategory: "Category", loadingCat: "Loading categories...", labelPriority: "Priority", selectPriority: "Select priority...",
          low: "Low", medium: "Medium", high: "High", labelDesc: "Description", placeholderDesc: "Provide detailed information...",
          labelAttach: "Attachment (Optional)", helpAttach: "Upload an image if needed (PNG, JPG, GIF)",
          submitBtn: "Create Ticket", cancelBtn: "Cancel", creating: "Creating..."
        },
        bg: {
          brand: "IT Help Desk", backBtn: "‚Üê –û–±—Ä–∞—Ç–Ω–æ –∫—ä–º –¢–∞–±–ª–æ—Ç–æ",
          createTitle: "–°—ä–∑–¥–∞–π –ù–æ–≤ –¢–∏–∫–µ—Ç", labelTitle: "–ó–∞–≥–ª–∞–≤–∏–µ", placeholderTitle: "–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞",
          labelCategory: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", loadingCat: "–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...", labelPriority: "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç", selectPriority: "–ò–∑–±–µ—Ä–µ—Ç–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç...",
          low: "–ù–∏—Å—ä–∫", medium: "–°—Ä–µ–¥–µ–Ω", high: "–í–∏—Å–æ–∫", labelDesc: "–û–ø–∏—Å–∞–Ω–∏–µ", placeholderDesc: "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–µ—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...",
          labelAttach: "–ü—Ä–∏–∫–∞—á–µ–Ω —Ñ–∞–π–ª (–ü–æ –∂–µ–ª–∞–Ω–∏–µ)", helpAttach: "–ö–∞—á–µ—Ç–µ —Å–Ω–∏–º–∫–∞, –∞–∫–æ –µ –Ω—É–∂–Ω–æ (PNG, JPG, GIF)",
          submitBtn: "–°—ä–∑–¥–∞–π –¢–∏–∫–µ—Ç", cancelBtn: "–û—Ç–∫–∞–∑", creating: "–°—ä–∑–¥–∞–≤–∞–Ω–µ..."
        }
      };

      let currentLang = localStorage.getItem('lang') || 'en';

      function applyTranslations() {
        const texts = dictionary[currentLang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
          if (texts[el.getAttribute('data-i18n')]) el.textContent = texts[el.getAttribute('data-i18n')];
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          if (texts[el.getAttribute('data-i18n-placeholder')]) el.placeholder = texts[el.getAttribute('data-i18n-placeholder')];
        });
        document.getElementById('langLabel').textContent = currentLang === 'bg' ? 'üåê BG' : 'üåê EN';
      }

      window.changeLanguage = function(lang) {
        currentLang = lang;
        localStorage.setItem('lang', lang);
        applyTranslations();
      };
      
      applyTranslations(); // –ò–∑–≤–∏–∫–≤–∞–º–µ –≤–µ–¥–Ω–∞–≥–∞

      // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—Ç–∞ –ª–æ–≥–∏–∫–∞ –∑–∞ –∑–∞–ø–∞–∑–≤–∞–Ω–µ (Auth, LoadCategories, Submit)
      async function checkAuth() {
        const { data: { session } } = await supabase.auth.getSession()
        if (!session) window.location.href = 'login.html'
        return session
      }

      async function loadCategories() {
        const { data } = await supabase.from('categories').select('*').order('name')
        const select = document.getElementById('category')
        if (data) {
          select.innerHTML = `<option value="" data-i18n="selectPriority">${currentLang === 'bg' ? '–ò–∑–±–µ—Ä–µ—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è...' : 'Select a category...'}</option>`
          data.forEach(c => select.innerHTML += `<option value="${c.id}">${c.name}</option>`)
        }
      }

      document.getElementById('ticketForm').addEventListener('submit', async (e) => {
        e.preventDefault()
        const btn = document.getElementById('submitBtn')
        btn.disabled = true; btn.textContent = dictionary[currentLang].creating;

        try {
          const session = await checkAuth()
          const fileInput = document.getElementById('fileUpload')
          let attachmentUrl = null

          if (fileInput.files[0]) {
            const file = fileInput.files[0]
            const filePath = `${session.user.id}/${Date.now()}.${file.name.split('.').pop()}`
            await supabase.storage.from('attachments').upload(filePath, file)
            attachmentUrl = supabase.storage.from('attachments').getPublicUrl(filePath).data.publicUrl
          }

          await supabase.from('tickets').insert([{
            user_id: session.user.id, category_id: document.getElementById('category').value,
            title: document.getElementById('title').value, description: document.getElementById('description').value,
            priority: document.getElementById('priority').value, attachment_url: attachmentUrl, status: 'open'
          }])
          window.location.href = 'dashboard.html'
        } catch (err) {
          alert('Error: ' + err.message); btn.disabled = false; btn.textContent = dictionary[currentLang].submitBtn;
        }
      })

      checkAuth().then(() => loadCategories())
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  </body>
</html>