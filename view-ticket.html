<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>View Ticket - IT Help Desk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="/src/style.css">
    <script>
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.setAttribute('data-bs-theme', 'dark');
      }
    </script>
  </head>
  <body class="bg-body-secondary">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="dashboard.html" data-i18n="brand">IT Help Desk</a>
        <div class="collapse navbar-collapse justify-content-end" id="nav">
          <ul class="navbar-nav align-items-center">
            <li class="nav-item">
              <a class="nav-link text-white" href="dashboard.html" data-i18n="backBtn">← Back to Dashboard</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
          <div id="alertContainer"></div>
          
          <div id="loadingSpinner" class="text-center mt-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2" data-i18n="loading">Loading ticket details...</p>
          </div>
          
          <div id="ticketContainer" style="display: none;">
            </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { supabase } from './src/supabase.js'

      // i18n Речник
      const dictionary = {
        en: {
          brand: "IT Help Desk", backBtn: "← Back to Dashboard", loading: "Loading ticket details...",
          lblPriority: "Priority:", lblCategory: "Category:", lblCreated: "Created:",
          lblDesc: "Description", lblAttach: "Attachment",
          status_open: "open", status_inprogress: "in progress", status_closed: "closed", status_resolved: "resolved",
          priority_low: "low", priority_medium: "medium", priority_high: "high"
        },
        bg: {
          brand: "IT Help Desk", backBtn: "← Обратно към Таблото", loading: "Зареждане на детайли...",
          lblPriority: "Приоритет:", lblCategory: "Категория:", lblCreated: "Създаден:",
          lblDesc: "Описание", lblAttach: "Прикачен файл",
          status_open: "отворен", status_inprogress: "в процес", status_closed: "затворен", status_resolved: "решен",
          priority_low: "нисък", priority_medium: "среден", priority_high: "висок"
        }
      };

      let currentLang = localStorage.getItem('lang') || 'en';

      // Превежда статичните HTML елементи (като менюто)
      function applyTranslations() {
        const texts = dictionary[currentLang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (texts[key]) el.textContent = texts[key];
        });
      }

      applyTranslations(); // Извикваме веднага при зареждане

      async function checkAuth() {
        const { data: { session }, error } = await supabase.auth.getSession()
        if (error || !session) {
          window.location.href = 'login.html'
          return null
        }
        return session
      }

      function getTicketIdFromUrl() {
        return new URLSearchParams(window.location.search).get('id')
      }

      async function loadTicket(ticketId) {
        const { data, error } = await supabase
          .from('tickets')
          .select('*, categories(name)')
          .eq('id', ticketId)
          .single()

        if (error) {
          document.getElementById('loadingSpinner').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
          return;
        }

        if (data) {
          displayTicket(data);
        }
      }

      function displayTicket(ticket) {
        const container = document.getElementById('ticketContainer');
        document.getElementById('loadingSpinner').style.display = 'none';
        container.style.display = 'block';

        const t = dictionary[currentLang];
        
        const statusMap = { 'open': 'success', 'in-progress': 'primary', 'closed': 'secondary', 'resolved': 'info' };
        const prMap = { 'low': 'info', 'medium': 'warning', 'high': 'danger' };
        
        // ВАЖНО: Обръщаме ги с малки букви, за да съвпаднат с речника, дори ако са записани като "Low" или "High"
        const rawStatus = (ticket.status || 'open').toLowerCase();
        const rawPriority = (ticket.priority || 'low').toLowerCase();

        const trStatus = t[`status_${rawStatus.replace('-', '')}`] || rawStatus;
        const trPriority = t[`priority_${rawPriority}`] || rawPriority;

        let attachHtml = '';
        if (ticket.attachment_url) {
          attachHtml = `
            <div class="mt-4">
              <h6>${t.lblAttach}</h6>
              <img src="${ticket.attachment_url}" class="img-fluid mt-3 rounded" style="max-height: 400px; object-fit: cover;">
            </div>`;
        }

        container.innerHTML = `
          <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <h4 class="mb-0">${String(ticket.title).replace(/</g, '&lt;')}</h4>
              <span class="badge bg-${statusMap[rawStatus] || 'secondary'} fs-6 text-capitalize">${trStatus}</span>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <p class="mb-2"><strong>${t.lblPriority}</strong> <span class="badge bg-${prMap[rawPriority] || 'secondary'} text-capitalize">${trPriority}</span></p>
                </div>
                <div class="col-md-6">
                  <p class="mb-2"><strong>${t.lblCategory}</strong> <span class="badge bg-secondary">${ticket.categories?.name || 'Uncategorized'}</span></p>
                </div>
              </div>
              <p class="text-muted"><strong>${t.lblCreated}</strong> ${new Date(ticket.created_at).toLocaleString()}</p>
              
              <div class="bg-body-tertiary p-3 rounded mb-3">
                <h6>${t.lblDesc}</h6>
                <p class="mb-0">${String(ticket.description).replace(/</g, '&lt;').replace(/\n/g, '<br>')}</p>
              </div>
              
              ${attachHtml}
              
              <div class="mt-4 pt-3 border-top">
                <a href="dashboard.html" class="btn btn-outline-primary">${t.backBtn}</a>
              </div>
            </div>
          </div>`;
      }

      ;(async () => {
        const session = await checkAuth();
        if (session) {
          const ticketId = getTicketIdFromUrl();
          if (ticketId) loadTicket(ticketId);
        }
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  </body>
</html>