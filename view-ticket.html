<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>View Ticket - IT Help Desk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="/src/style.css">
  </head>
  <body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="#">IT Help Desk</a>
        <div class="collapse navbar-collapse justify-content-end" id="nav">
          <ul class="navbar-nav align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">Dashboard</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
          <div id="alertContainer"></div>
          <div id="loadingSpinner" class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading ticket details...</p>
          </div>
          <div id="ticketContainer" style="display: none;">
            <!-- Ticket will be rendered here -->
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { supabase } from './src/supabase.js'

      // Auth check - redirect if not logged in
      async function checkAuth() {
        const { data: { session }, error } = await supabase.auth.getSession()
        
        if (error || !session) {
          window.location.href = 'login.html'
          return null
        }
        
        return session
      }

      // Get ticket ID from URL query parameters
      function getTicketIdFromUrl() {
        const params = new URLSearchParams(window.location.search)
        const ticketId = params.get('id')
        
        if (!ticketId) {
          showErrorAndRedirect('No ticket ID provided. Redirecting to dashboard...')
          return null
        }
        
        return ticketId
      }

      // Show alert messages
      function showAlert(message, type = 'info') {
        const alertContainer = document.getElementById('alertContainer')
        const alert = document.createElement('div')
        alert.className = `alert alert-${type} alert-dismissible fade show`
        alert.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `
        alertContainer.innerHTML = ''
        alertContainer.appendChild(alert)
      }

      // Show error and redirect
      function showErrorAndRedirect(message) {
        const container = document.getElementById('ticketContainer')
        const spinner = document.getElementById('loadingSpinner')
        
        spinner.style.display = 'none'
        container.style.display = 'block'
        
        const errorCard = `
          <div class="card border-danger">
            <div class="card-body text-center">
              <h5 class="card-title text-danger">Error</h5>
              <p class="card-text">${message}</p>
              <a href="dashboard.html" class="btn btn-primary">Back to Dashboard</a>
            </div>
          </div>
        `
        container.innerHTML = errorCard
      }

      // Get status badge color
      function getStatusBadgeClass(status) {
        const statusMap = {
          'open': 'success',
          'in-progress': 'primary',
          'closed': 'secondary',
          'resolved': 'info',
          'pending': 'warning'
        }
        return statusMap[status] || 'secondary'
      }

      // Get priority badge color
      function getPriorityColor(priority) {
        const priorityMap = {
          'low': 'info',
          'medium': 'warning',
          'high': 'danger'
        }
        return priorityMap[priority] || 'secondary'
      }

      // Format date
      function formatDate(dateString) {
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }
        return new Date(dateString).toLocaleDateString('en-US', options)
      }

      // Fetch and display ticket details
      async function loadTicket(ticketId) {
        try {
          const { data, error } = await supabase
            .from('tickets')
            .select('*, categories(name)')
            .eq('id', ticketId)
            .single()

          if (error) {
            throw new Error('Ticket not found')
          }

          if (!data) {
            throw new Error('Ticket not found')
          }

          displayTicket(data)

        } catch (error) {
          console.error('Error loading ticket:', error)
          showErrorAndRedirect(`Error: ${error.message}`)
        }
      }

      // Display ticket in the UI
      function displayTicket(ticket) {
        const spinner = document.getElementById('loadingSpinner')
        const container = document.getElementById('ticketContainer')

        const statusBadgeClass = getStatusBadgeClass(ticket.status)
        const priorityBadgeClass = getPriorityColor(ticket.priority)
        const formattedDate = formatDate(ticket.created_at)
        const categoryName = ticket.categories?.name || 'Uncategorized'

        let attachmentHtml = ''
        if (ticket.attachment_url) {
          attachmentHtml = `
            <div class="mt-4">
              <h6>Attachment</h6>
              <img src="${ticket.attachment_url}" alt="Ticket attachment" class="img-fluid mt-3 rounded" style="max-height: 400px; object-fit: cover;">
            </div>
          `
        }

        const ticketHtml = `
          <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-start">
              <div>
                <h4 class="mb-0">${escapeHtml(ticket.title)}</h4>
              </div>
              <span class="badge bg-${statusBadgeClass}">${ticket.status}</span>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <p class="mb-2">
                    <strong>Priority:</strong>
                    <span class="badge bg-${priorityBadgeClass} text-capitalize">${ticket.priority}</span>
                  </p>
                </div>
                <div class="col-md-6">
                  <p class="mb-2">
                    <strong>Category:</strong>
                    <span class="badge bg-secondary">${escapeHtml(categoryName)}</span>
                  </p>
                </div>
              </div>

              <p class="text-muted mb-3">
                <strong>Created:</strong> ${formattedDate}
              </p>

              <div class="bg-light p-3 rounded mb-3">
                <h6 class="mb-2">Description</h6>
                <p class="mb-0">${escapeHtml(ticket.description).replace(/\n/g, '<br>')}</p>
              </div>

              ${attachmentHtml}

              <div class="mt-4 pt-3 border-top">
                <a href="dashboard.html" class="btn btn-outline-primary">
                  ‚Üê Back to Dashboard
                </a>
              </div>
            </div>
          </div>
        `

        spinner.style.display = 'none'
        container.style.display = 'block'
        container.innerHTML = ticketHtml
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        }
        return text.replace(/[&<>"']/g, m => map[m])
      }

      // Initialize page
      ;(async () => {
        const session = await checkAuth()
        if (session) {
          const ticketId = getTicketIdFromUrl()
          if (ticketId) {
            await loadTicket(ticketId)
          }
        }
      })()
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </body>
</html>
