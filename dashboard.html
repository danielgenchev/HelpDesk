<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard - IT Help Desk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="/src/style.css">
  </head>
  <body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="#">IT Help Desk</a>
        <div class="collapse navbar-collapse justify-content-end" id="nav">
          <ul class="navbar-nav align-items-center">
            <li class="nav-item me-3">
              <span class="nav-link text-white" id="userEmail"></span>
            </li>
            <li class="nav-item">
              <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container mt-5">
      <div id="alertContainer"></div>

      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">My Tickets</h2>
        <a class="btn btn-primary shadow-sm" href="create-ticket.html">+ Create New Ticket</a>
      </div>

      <div id="noTickets" class="text-center text-muted my-5 d-none">
        <h4>No tickets found</h4>
        <p>You haven't created any support tickets yet.</p>
      </div>

      <div class="card shadow-sm d-none" id="ticketTableCard">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th class="ps-4">Title</th>
                  <th>Priority</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th class="text-end pe-4">Actions</th>
                </tr>
              </thead>
              <tbody id="ticket-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { supabase } from './src/supabase.js'

      const alertContainer = document.getElementById('alertContainer')
      const userEmailEl = document.getElementById('userEmail')
      const logoutBtn = document.getElementById('logoutBtn')
      const ticketTableCard = document.getElementById('ticketTableCard')
      const ticketTbody = document.getElementById('ticket-table-body')
      const noTicketsEl = document.getElementById('noTickets')

      function showAlert(message, type = 'danger') {
        alertContainer.innerHTML = `
          <div class="alert alert-${type} alert-dismissible" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>`
      }

      async function ensureAuth() {
        const { data } = await supabase.auth.getSession()
        const session = data?.session ?? null
        if (!session || !session.user) {
          window.location.href = 'login.html'
          return null
        }
        return session.user
      }

      // Помощни функции за цветни етикети
      function getStatusBadge(status) {
        const map = { 'open': 'success', 'in-progress': 'primary', 'closed': 'secondary', 'resolved': 'info' }
        return `<span class="badge bg-${map[status] || 'secondary'}">${status}</span>`
      }

      function getPriorityBadge(priority) {
        const map = { 'low': 'info', 'medium': 'warning', 'high': 'danger' }
        return `<span class="badge bg-${map[priority] || 'secondary'} text-capitalize">${priority}</span>`
      }

      async function loadTickets(user) {
        ticketTbody.innerHTML = ''
        noTicketsEl.classList.add('d-none')

        const { data: tickets, error } = await supabase
          .from('tickets')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })

        if (error) {
          showAlert(error.message || 'Failed to load tickets')
          return
        }

        if (!tickets || tickets.length === 0) {
          ticketTableCard.classList.add('d-none')
          noTicketsEl.classList.remove('d-none')
          return
        }

        ticketTableCard.classList.remove('d-none')

        for (const t of tickets) {
          const tr = document.createElement('tr')
          const dateText = t.created_at ? new Date(t.created_at).toLocaleDateString() : ''

          tr.innerHTML = `
            <td class="ps-4 fw-medium">${escapeHtml(t.title || '')}</td>
            <td>${getPriorityBadge(t.priority)}</td>
            <td>${getStatusBadge(t.status)}</td>
            <td class="text-muted small">${escapeHtml(dateText)}</td>
            <td class="text-end pe-4">
              <a class="btn btn-sm btn-outline-primary" href="view-ticket.html?id=${encodeURIComponent(t.id)}">View</a>
            </td>
          `
          ticketTbody.appendChild(tr)
        }
      }

      function escapeHtml(str) {
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;')
      }

      logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut()
        window.location.href = 'login.html'
      })

      // Initialize
      ;(async () => {
        const user = await ensureAuth()
        if (!user) return
        userEmailEl.textContent = user.email || ''
        await loadTickets(user)
      })()
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  </body>
</html>