<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard - IT Help Desk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="/src/style.css">
    <script>
      // –ü—Ä–∏–ª–∞–≥–∞ —Ç—ä–º–Ω–∞—Ç–∞ —Ç–µ–º–∞ –≤–µ–¥–Ω–∞–≥–∞
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.setAttribute('data-bs-theme', 'dark');
      }
    </script>
  </head>
  <body class="bg-body-secondary">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="#" data-i18n="brand">IT Help Desk</a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse justify-content-end" id="nav">
          <ul class="navbar-nav align-items-center">
            
            <li class="nav-item dropdown me-3">
              <a class="nav-link dropdown-toggle text-white" href="#" id="langLabel" role="button" data-bs-toggle="dropdown">
                üåê EN
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" onclick="changeLanguage('en')">English (EN)</a></li>
                <li><a class="dropdown-item" href="#" onclick="changeLanguage('bg')">–ë—ä–ª–≥–∞—Ä—Å–∫–∏ (BG)</a></li>
              </ul>
            </li>

            <li class="nav-item me-3">
              <span class="nav-link text-white-50" id="userEmail"></span>
            </li>
            
            <li class="nav-item me-2">
              <a href="settings.html" class="btn btn-outline-light btn-sm" data-i18n="settingsBtn">‚öôÔ∏è Settings</a>
            </li>

            <li class="nav-item">
              <button id="logoutBtn" class="btn btn-danger btn-sm" data-i18n="logoutBtn">Logout</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container mt-5">
      <div id="alertContainer"></div>

      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0" data-i18n="myTicketsTitle">My Tickets</h2>
        <a class="btn btn-primary shadow-sm" href="create-ticket.html" data-i18n="createTicketBtn">+ Create New Ticket</a>
      </div>

      <div id="noTickets" class="text-center text-muted my-5 d-none">
        <h4 data-i18n="noTickets">No tickets found</h4>
        <p data-i18n="noTicketsDesc">You haven't created any support tickets yet.</p>
      </div>

      <div class="card shadow-sm d-none" id="ticketTableCard">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th class="ps-4" data-i18n="thTitle">Title</th>
                  <th data-i18n="thPriority">Priority</th>
                  <th data-i18n="thStatus">Status</th>
                  <th data-i18n="thDate">Date</th>
                  <th class="text-end pe-4" data-i18n="thActions">Actions</th>
                </tr>
              </thead>
              <tbody id="ticket-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { supabase } from './src/supabase.js'

      // --- –°–ò–°–¢–ï–ú–ê –ó–ê –ü–†–ï–í–û–î (i18n) ---
      const dictionary = {
        en: {
          brand: "IT Help Desk",
          settingsBtn: "‚öôÔ∏è Settings",
          logoutBtn: "Logout",
          myTicketsTitle: "My Tickets",
          createTicketBtn: "+ Create New Ticket",
          noTickets: "No tickets found",
          noTicketsDesc: "You haven't created any support tickets yet.",
          thTitle: "Title",
          thPriority: "Priority",
          thStatus: "Status",
          thDate: "Date",
          thActions: "Actions",
          viewBtn: "View",
          // –î–∏–Ω–∞–º–∏—á–Ω–∏ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ –∑–∞ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏
          status_open: "open", 
          status_inprogress: "in progress", 
          status_closed: "closed", 
          status_resolved: "resolved",
          priority_low: "low", 
          priority_medium: "medium", 
          priority_high: "high"
        },
        bg: {
          brand: "IT Help Desk",
          settingsBtn: "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏",
          logoutBtn: "–ò–∑—Ö–æ–¥",
          myTicketsTitle: "–ú–æ–∏—Ç–µ –¢–∏–∫–µ—Ç–∏",
          createTicketBtn: "+ –°—ä–∑–¥–∞–π –¢–∏–∫–µ—Ç",
          noTickets: "–ù—è–º–∞ —Ç–∏–∫–µ—Ç–∏",
          noTicketsDesc: "–í—Å–µ –æ—â–µ –Ω—è–º–∞—Ç–µ —Å—ä–∑–¥–∞–¥–µ–Ω–∏ —Ç–∏–∫–µ—Ç–∏.",
          thTitle: "–ó–∞–≥–ª–∞–≤–∏–µ",
          thPriority: "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç",
          thStatus: "–°—Ç–∞—Ç—É—Å",
          thDate: "–î–∞—Ç–∞",
          thActions: "–î–µ–π—Å—Ç–≤–∏—è",
          viewBtn: "–ü—Ä–µ–≥–ª–µ–¥",
          // –î–∏–Ω–∞–º–∏—á–Ω–∏ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ –∑–∞ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏
          status_open: "–æ—Ç–≤–æ—Ä–µ–Ω", 
          status_inprogress: "–≤ –ø—Ä–æ—Ü–µ—Å", 
          status_closed: "–∑–∞—Ç–≤–æ—Ä–µ–Ω", 
          status_resolved: "—Ä–µ—à–µ–Ω",
          priority_low: "–Ω–∏—Å—ä–∫", 
          priority_medium: "—Å—Ä–µ–¥–µ–Ω", 
          priority_high: "–≤–∏—Å–æ–∫"
        }
      };

      let currentLang = localStorage.getItem('lang') || 'en';

      function applyTranslations() {
        const texts = dictionary[currentLang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (texts[key]) el.textContent = texts[key];
        });
        document.getElementById('langLabel').textContent = currentLang === 'bg' ? 'üåê BG' : 'üåê EN';
      }

      window.changeLanguage = function(lang) {
        currentLang = lang;
        localStorage.setItem('lang', lang);
        applyTranslations();
        // –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–º–µ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞, –∑–∞ –¥–∞ —Å–µ –ø—Ä–µ–≤–µ–¥–∞—Ç —Å—Ç–∞—Ç—É—Å–∏—Ç–µ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∏—Ç–µ
        ensureAuth().then(user => { if(user) loadTickets(user); });
      };

      // –ü—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –µ–∑–∏–∫–∞
      applyTranslations();

      const alertContainer = document.getElementById('alertContainer');
      const userEmailEl = document.getElementById('userEmail');
      const logoutBtn = document.getElementById('logoutBtn');
      const ticketTableCard = document.getElementById('ticketTableCard');
      const ticketTbody = document.getElementById('ticket-table-body');
      const noTicketsEl = document.getElementById('noTickets');

      async function ensureAuth() {
        const { data } = await supabase.auth.getSession()
        const session = data?.session ?? null
        if (!session || !session.user) {
          window.location.href = 'login.html'
          return null
        }
        return session.user
      }

      // –§—É–Ω–∫—Ü–∏–∏ –∑–∞ –±–∞–¥–∂–æ–≤–µ—Ç–µ (—Å –≤–≥—Ä–∞–¥–µ–Ω –ø—Ä–µ–≤–æ–¥)
      function getStatusBadge(status) {
        const map = { 'open': 'success', 'in-progress': 'primary', 'closed': 'secondary', 'resolved': 'info' };
        // –í–∑–µ–º–∞–º–µ –ø—Ä–µ–≤–æ–¥–∞ –æ—Ç —Ä–µ—á–Ω–∏–∫–∞ —Å–ø—Ä—è–º–æ —Ç–µ–∫—É—â–∏—è –µ–∑–∏–∫
        const translatedStatus = dictionary[currentLang][`status_${status.replace('-', '')}`] || status;
        return `<span class="badge bg-${map[status] || 'secondary'} text-capitalize">${translatedStatus}</span>`;
      }

      function getPriorityBadge(priority) {
        const map = { 'low': 'info', 'medium': 'warning', 'high': 'danger' };
        // –í–∑–µ–º–∞–º–µ –ø—Ä–µ–≤–æ–¥–∞ –æ—Ç —Ä–µ—á–Ω–∏–∫–∞ —Å–ø—Ä—è–º–æ —Ç–µ–∫—É—â–∏—è –µ–∑–∏–∫
        const translatedPriority = dictionary[currentLang][`priority_${priority}`] || priority;
        return `<span class="badge bg-${map[priority] || 'secondary'} text-capitalize">${translatedPriority}</span>`;
      }

      async function loadTickets(user) {
        ticketTbody.innerHTML = '';
        noTicketsEl.classList.add('d-none');

        const { data: tickets, error } = await supabase
          .from('tickets')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (error) return;

        if (!tickets || tickets.length === 0) {
          ticketTableCard.classList.add('d-none');
          noTicketsEl.classList.remove('d-none');
          return;
        }

        ticketTableCard.classList.remove('d-none');
        const viewText = dictionary[currentLang].viewBtn;

        for (const t of tickets) {
          const tr = document.createElement('tr');
          const dateText = t.created_at ? new Date(t.created_at).toLocaleDateString() : '';

          tr.innerHTML = `
            <td class="ps-4 fw-medium">${String(t.title).replace(/</g, '&lt;')}</td>
            <td>${getPriorityBadge(t.priority)}</td>
            <td>${getStatusBadge(t.status)}</td>
            <td class="text-muted small">${dateText}</td>
            <td class="text-end pe-4">
              <a class="btn btn-sm btn-outline-primary" href="view-ticket.html?id=${t.id}">${viewText}</a>
            </td>
          `;
          ticketTbody.appendChild(tr);
        }
      }

      logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      });

      ;(async () => {
        const user = await ensureAuth();
        if (!user) return;
        userEmailEl.textContent = user.email || '';
        await loadTickets(user);
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  </body>
</html>