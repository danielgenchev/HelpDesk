<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard - IT Help Desk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-..." crossorigin="anonymous">
    <link rel="stylesheet" href="/src/style.css">
  </head>
  <body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="#">IT Help Desk</a>
        <div class="collapse navbar-collapse justify-content-end" id="nav">
          <ul class="navbar-nav align-items-center">
            <li class="nav-item me-3">
              <span class="nav-link" id="userEmail"></span>
            </li>
            <li class="nav-item">
              <button id="logoutBtn" class="btn btn-outline-secondary">Logout</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container mt-4">
      <div id="alertContainer"></div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>My Tickets</h2>
        <a class="btn btn-primary" href="create-ticket.html">Create New Ticket</a>
      </div>

      <div id="noTickets" class="text-center text-muted mb-3 d-none">No tickets found</div>

      <div class="table-responsive">
        <table class="table table-striped" id="ticketTable">
          <thead>
            <tr>
              <th>Title</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ticket-table-body"></tbody>
        </table>
      </div>
    </main>

    <script type="module">
      import { supabase } from './src/supabase.js'

      const alertContainer = document.getElementById('alertContainer')
      const userEmailEl = document.getElementById('userEmail')
      const logoutBtn = document.getElementById('logoutBtn')
      const ticketTable = document.getElementById('ticketTable')
      const ticketTbody = document.getElementById('ticket-table-body')
      const noTicketsEl = document.getElementById('noTickets')

      function showAlert(message, type = 'danger') {
        alertContainer.innerHTML = `
          <div class="alert alert-${type} alert-dismissible" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>`
      }

      async function ensureAuth() {
        const { data } = await supabase.auth.getSession()
        const session = data?.session ?? null
        if (!session || !session.user) {
          window.location.href = 'login.html'
          return null
        }
        return session.user
      }

      async function loadTickets(user) {
        ticketTbody.innerHTML = ''
        noTicketsEl.classList.add('d-none')

        const { data: tickets, error } = await supabase
          .from('tickets')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })

        if (error) {
          showAlert(error.message || 'Failed to load tickets')
          return
        }

        if (!tickets || tickets.length === 0) {
          ticketTable.classList.add('d-none')
          noTicketsEl.classList.remove('d-none')
          return
        }

        ticketTable.classList.remove('d-none')

        for (const t of tickets) {
          const tr = document.createElement('tr')

          const dateText = t.created_at ? new Date(t.created_at).toLocaleString() : ''

          tr.innerHTML = `
            <td>${escapeHtml(t.title || '')}</td>
            <td>${escapeHtml(t.priority || '')}</td>
            <td>${escapeHtml(t.status || '')}</td>
            <td>${escapeHtml(dateText)}</td>
            <td>
              <a class="btn btn-sm btn-outline-primary" href="view-ticket.html?id=${encodeURIComponent(t.id)}">View</a>
            </td>
          `

          ticketTbody.appendChild(tr)
        }
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;')
      }

      logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut()
        window.location.href = 'login.html'
      })

      // initialize
      ;(async () => {
        const user = await ensureAuth()
        if (!user) return
        userEmailEl.textContent = user.email || ''
        await loadTickets(user)
      })()
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-..." crossorigin="anonymous"></script>
  </body>
</html>
